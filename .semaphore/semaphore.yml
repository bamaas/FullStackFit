version: v1.0
name: Build release candidate images
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Check
    task:
      jobs:
        - name: linter
          commands: 
            - pip install flake8
            - echo linting...
        - name: unit tests
          commands: 
            - make test-unit
      prologue:
        commands:
          - checkout
          - sem-version python 3.7
  - name: Build RC
    task:
      jobs:
        - name: database
          commands:
            - make build-db
            - docker push ${DOCKER_USERNAME}/fullstackfit_database:rc.${GIT_COMMIT_SHA}
        - name: backend
          commands:
            - make build-be
            - docker push ${DOCKER_USERNAME}/fullstackfit_backend:rc.${GIT_COMMIT_SHA}
        - name: frontend
          commands:
            - make build-fe
            - docker push ${DOCKER_USERNAME}/fullstackfit_frontend:rc.${GIT_COMMIT_SHA}
        - name: proxy
          commands:
            - make build-proxy
            - docker push ${DOCKER_USERNAME}/fullstackfit_reverseproxy:rc.${GIT_COMMIT_SHA}
      prologue:
        commands:
          - checkout
          - export GIT_COMMIT_SHA=$(git rev-parse --short HEAD)
          - echo $GIT_COMMIT_SHA
          - echo $DOCKER_PASSWORD | docker login --username "$DOCKER_USERNAME" --password-stdin
      secrets:
        - name: Docker
promotions:
- name: Test RC
  pipeline_file: test.yml
  auto_promote:
    when: "result = 'passed'"
execution_time_limit:
  minutes: 30
