version: v1.0
name: Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Checkout
    task:
      jobs:
        - name: linter
          commands: 
            - pip install flake8
            - echo linting...
        - name: unit tests
          commands: 
            - make test-unit
      prologue:
        commands:
          - checkout
          - sem-version python 3.7
  - name: Build
    task:
      jobs:
        - name: images
          commands:
            - make build
      prologue:
        commands:
          - checkout
      epilogue:
        always:
          commands:
            - make shutdown
        on_pass:
          commands:
            - echo $DOCKER_PASSWORD | docker login --username "$DOCKER_USERNAME" --password-stdin
            - echo ${DOCKER_USERNAME}/fullstackfit_frontend:rc.${SEMAPHORE_WORKFLOW_ID} ${DOCKER_USERNAME}/fullstackfit_backend:rc.${SEMAPHORE_WORKFLOW_ID} ${DOCKER_USERNAME}/fullstackfit_reverseproxy:rc.${SEMAPHORE_WORKFLOW_ID} ${DOCKER_USERNAME}/fullstackfit_database:rc.${SEMAPHORE_WORKFLOW_ID} | xargs -n 1 docker push
      secrets:
        - name: Docker

execution_time_limit:
  minutes: 30
