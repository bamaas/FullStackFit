version: v1.0
name: Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Build & Test & Push
    task:
      jobs:
        - name: Bas
          commands:
            - checkout
            - make test-unit
            - make build
            - echo $DOCKER_PASSWORD | docker login --username "$DOCKER_USERNAME" --password-stdin
            # Push all images to Docker Hub
             - echo 
             ${DOCKER_USERNAME}/fullstackfit_frontend:${SEMAPHORE_WORKFLOW_ID} 
             ${DOCKER_USERNAME}/fullstackfit_backend:${SEMAPHORE_WORKFLOW_ID} 
             ${DOCKER_USERNAME}/fullstackfit_reverseproxy:${SEMAPHORE_WORKFLOW_ID} 
             ${DOCKER_USERNAME}/fullstackfit_database:${SEMAPHORE_WORKFLOW_ID} | xargs -n 1 docker push
      epilogue:
        always:
          commands:
            - make shutdown
            - artifact push workflow ./test/logs/testlog-WS-\(build\).html
            - artifact push workflow ./test/logs/testlog-GUI-\(build\).html
            - artifact push workflow ./test/logs/testlog-WS-\(prod\).html
            - artifact push workflow ./test/logs/testlog-GUI-\(prod\).html
      secrets:
        - name: Docker
        - name: google-cloud-stg
execution_time_limit:
  minutes: 30
