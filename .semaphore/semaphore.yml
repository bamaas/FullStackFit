version: v1.0
name: Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Build & Test & Push
    task:
      jobs:
        - name: Bas
          commands:
            - gcloud auth activate-service-account --key-file=.secrets.gcp.json
            - chmod 600 google_compute_engine
            - chmod 600 google_compute_engine.pub
            - gcloud compute ssh instance-2 --project united-watch-268115 --zone us-central1-a --ssh-key-file=$SEMAPHORE_PROJECT_NAME/google_compute_engine --command='cd FullStackFit && docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD:$PWD" -w="$PWD" docker/compose:1.24.0  -f docker-compose-run-latest.yml pull && docker run --rm -v /var/run/docker.sock:/var/run/docker.sock -v "$PWD:$PWD" -w="$PWD" docker/compose:1.24.0  -f docker-compose-run-latest.yml up -d'
            - checkout
            - make asdfsdaf
            - make test-unit
            - docker-compose -f docker-compose-build-prod.yml build
            - docker-compose -f docker-compose-build-prod.yml up -d
            - 'docker tag bamaas/fullstackfit_frontend:prod "$DOCKER_USERNAME"/fullstackfit_frontend:latest'
            - 'docker tag bamaas/fullstackfit_backend:prod "$DOCKER_USERNAME"/fullstackfit_backend:latest'
            - 'docker tag bamaas/fullstackfit_database:prod "$DOCKER_USERNAME"/fullstackfit_database:latest'
            - 'docker tag bamaas/fullstackfit_reverseproxy:prod "$DOCKER_USERNAME"/fullstackfit_reverseproxy:latest'
            - echo $DOCKER_PASSWORD | docker login --username "$DOCKER_USERNAME" --password-stdin
            - 'docker pull "$DOCKER_USERNAME"/fullstackfit_test:latest || true'
            - make test-ws
            - make test-e2e
            - docker images
            - 'docker push "$DOCKER_USERNAME"/fullstackfit_frontend:latest'
            - 'docker push "$DOCKER_USERNAME"/fullstackfit_backend:latest'
            - 'docker push "$DOCKER_USERNAME"/fullstackfit_database:latest'
            - 'docker push "$DOCKER_USERNAME"/fullstackfit_reverseproxy:latest'
            - 'docker push "$DOCKER_USERNAME"/fullstackfit_test:latest'
      epilogue:
        always:
          commands:
            - make shutdown
      secrets:
        - name: Docker
        - name: google-cloud-stg
    skip:
      when: branch != 'master'
execution_time_limit:
  minutes: 30
